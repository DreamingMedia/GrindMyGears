<html>
	<head>
	<script src="./jquery-2.1.1.min.js"></script>
	<script src="./jQueryRotate.js"></script>
	<link rel="stylesheet" href="./styles.css" />
	<script>

		$.fn.observe = function(eventName, callback) {
    return this.each(function(){
        var el = this;
        $(document).on(eventName, function(){
            callback.apply(el, arguments);
        })
    })
}

		function GearsLineUp(myAngle, leftGearAngle) {
			return Math.abs( 270 - myAngle ) < 2  &&  Math.abs( 270 - leftGearAngle ) < 2
		}
		$( document ).ready( function(){

			// create the required number of slave gears with default config for now, and return an array
			// of gears.
			function appendAndCaptureSlaveGears(numGear) {
				for (var i = 0; i < numGear; i++ ){
					$("#gears").append('<img src="g3.png" id="gear' + i + '" radius="20" class="slave"/>')
				}

				var retVal = [];
				$(".slave").each(function(i, gear) {
					retVal.push($(gear));
				});

				return retVal;
			}


			var numSlaves = 4;


			var $gears = {
				"$driver" : $("#driverGear"),
				"slaves" : appendAndCaptureSlaveGears(numSlaves)
			};


			for (var i = 0; i < $gears.slaves.length; i++) {
				$gears.slaves[i].rotate({angle: 0});
			}

			$gears.$driver.rotate({angle:0});

			var xOriginalDriverGear = $gears.$driver.position().left
			console.log( 'xOriginalDriverGear' )
			console.log( xOriginalDriverGear )
			
			
			
			
			

			$gears.$driver.rotate({bind:{
				click: function(){
					var $obj = $(this )
					var lastAngle = $obj.getRotateAngle()[0]
					$(this).rotate({
						angle: 0,
						animateTo: 360 * 10,
						duration:(10 * 100 * 8) * 10 ,
						easing: function(x, t, b, c, d) { return b+(t/d)*c ; },
						step: function( a ){
							var angleDelta = $obj.getRotateAngle()[0] - lastAngle
							lastAngle = $obj.getRotateAngle()[0]
							var arcLength = Math.abs( (2 * parseFloat($obj.attr('radius')) * Math.PI) * (angleDelta / 360.0) )
							$obj.trigger( 'rotate', { 'arcLength' : arcLength, 'a' : a } )

						},
					})
      			}
  			}});

			// each slave gear gets the ted magic formula referncing the gear on the left.
			// Obviously slaves[0] needs to look at the driver gear
			for (var i = 0; i < $gears.slaves.length; i++) {
				$gears.slaves[i].observe('rotate', function(e, d) {
					var angleDelta = (d.arcLength/(2 * parseFloat($(this).attr('radius')) * Math.PI)) * 360;
					var newAngle = $(this).getRotateAngle()[0] - angleDelta;

					var myAngle = -1 * newAngle % 360;
					var leftGear = i == 0 ? $gears.$driver : $gears.slaves[i - 1];
					var leftGearAngle = leftGear.getRotateAngle()[0] % 360;
					if (GearsLineUp(myAngle, leftGearAngle)) {
						alert('got one');
					}

					$(this).rotate({angle: newAngle});
				});
			}

		$('#grow' ).click( function(){
				
				var $obj = $('#driverGear' )				
				$obj.attr('radius', parseInt( $obj.attr('radius') ) + 2)
				$obj.attr('width', parseInt( $obj.attr('radius') ) * 10)
				
				console.log( $obj.attr('radius') )
				
			});

		$('#shrink' ).click( function(){
				var $obj = $('#driverGear' )				
				$obj.attr('radius', parseInt( $obj.attr('radius') ) - 2)
				$obj.attr('width', parseInt( $obj.attr('radius') ) * 10)

			})
			
		} )
		
		</script>
	</head>
	<body>
		
		<a id="grow" href="#">grow me</a>
		<a id="shrink" href="#">shrink me</a>
		<br><br>		<br>		<br>		<br>
		<div id="gears">
			<img src="g1.png" id="driverGear" radius="10" class="driver" />
			<!-- child gears will be created on the run -->
		</div>

		
	</body>
</html>